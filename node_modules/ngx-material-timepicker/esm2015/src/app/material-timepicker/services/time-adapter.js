import { DateTime } from 'luxon';
import { TimeFormat } from '../models/time-format.enum';
import { TimePeriod } from '../models/time-period.enum';
import { isBetween, isSameOrAfter, isSameOrBefore } from '../utils/timepicker.utils';
// @dynamic
export class TimeAdapter {
    static parseTime(time, opts) {
        const { numberingSystem, locale } = TimeAdapter.getLocaleOptionsByTime(time, opts);
        const isPeriodExist = time.split(' ').length === 2;
        const timeMask = isPeriodExist ? TimeFormat.TWELVE_SHORT : TimeFormat.TWENTY_FOUR_SHORT;
        return DateTime.fromFormat(time, timeMask, { numberingSystem, locale });
    }
    static formatTime(time, opts) {
        var _a, _b;
        const { format } = opts;
        const parsedTime = TimeAdapter.parseTime(time, opts).setLocale(TimeAdapter.DEFAULT_LOCALE);
        if (format !== 24) {
            return (_a = parsedTime.toLocaleString(Object.assign(Object.assign({}, DateTime.TIME_SIMPLE), { hour12: format !== 24, numberingSystem: TimeAdapter.DEFAULT_NUMBERING_SYSTEM }))) === null || _a === void 0 ? void 0 : _a.replace(/\u200E/g, '');
        }
        return (_b = parsedTime.toISOTime({
            includeOffset: false,
            suppressMilliseconds: true,
            suppressSeconds: true
        })) === null || _b === void 0 ? void 0 : _b.replace(/\u200E/g, '');
    }
    static toLocaleTimeString(time, opts = {}) {
        const { format = TimeAdapter.DEFAULT_FORMAT, locale = TimeAdapter.DEFAULT_LOCALE } = opts;
        const timeFormat = Object.assign(Object.assign({}, DateTime.TIME_SIMPLE), { hour12: format !== 24 });
        const timeMask = (format === 24) ? TimeFormat.TWENTY_FOUR_SHORT : TimeFormat.TWELVE_SHORT;
        return DateTime.fromFormat(time, timeMask).setLocale(locale).toLocaleString(timeFormat);
    }
    static isTimeAvailable(time, min, max, granularity, minutesGap, format) {
        if (!time) {
            return;
        }
        const convertedTime = this.parseTime(time, { format });
        const minutes = convertedTime.minute;
        if (minutesGap && minutes === minutes && minutes % minutesGap !== 0) {
            throw new Error(`Your minutes - ${minutes} doesn\'t match your minutesGap - ${minutesGap}`);
        }
        const isAfter = (min && !max)
            && isSameOrAfter(convertedTime, min, granularity);
        const isBefore = (max && !min)
            && isSameOrBefore(convertedTime, max, granularity);
        const between = (min && max)
            && isBetween(convertedTime, min, max, granularity);
        const isAvailable = !min && !max;
        return isAfter || isBefore || between || isAvailable;
    }
    /***
     *  Format hour according to time format (12 or 24)
     */
    static formatHour(currentHour, format, period) {
        if (format === 24) {
            return currentHour;
        }
        const hour = period === TimePeriod.AM ? currentHour : currentHour + 12;
        if (period === TimePeriod.AM && hour === 12) {
            return 0;
        }
        else if (period === TimePeriod.PM && hour === 24) {
            return 12;
        }
        return hour;
    }
    static fromDateTimeToString(time, format) {
        const timeFormat = format === 24 ? TimeFormat.TWENTY_FOUR : TimeFormat.TWELVE;
        return time.reconfigure({
            numberingSystem: TimeAdapter.DEFAULT_NUMBERING_SYSTEM,
            locale: TimeAdapter.DEFAULT_LOCALE
        }).toFormat(timeFormat);
    }
    static getLocaleOptionsByTime(time, opts) {
        const { numberingSystem, locale } = DateTime.local().setLocale(opts.locale).resolvedLocaleOpts();
        const localeConfig = { numberingSystem: numberingSystem, locale };
        const defaultConfig = { numberingSystem: TimeAdapter.DEFAULT_NUMBERING_SYSTEM, locale: TimeAdapter.DEFAULT_LOCALE };
        return isNaN(parseInt(time, 10)) ? localeConfig : defaultConfig;
    }
}
TimeAdapter.DEFAULT_FORMAT = 12;
TimeAdapter.DEFAULT_LOCALE = 'en-US';
TimeAdapter.DEFAULT_NUMBERING_SYSTEM = 'latn';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZS1hZGFwdGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LW1hdGVyaWFsLXRpbWVwaWNrZXIvIiwic291cmNlcyI6WyJzcmMvYXBwL21hdGVyaWFsLXRpbWVwaWNrZXIvc2VydmljZXMvdGltZS1hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxRQUFRLEVBQXdELE1BQU0sT0FBTyxDQUFDO0FBRXRGLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUN0RCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFDdEQsT0FBTyxFQUFDLFNBQVMsRUFBRSxhQUFhLEVBQUUsY0FBYyxFQUFDLE1BQU0sMkJBQTJCLENBQUM7QUFHbkYsV0FBVztBQUNYLE1BQU0sT0FBTyxXQUFXO0lBS3BCLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBWSxFQUFFLElBQWlCO1FBQzVDLE1BQU0sRUFBQyxlQUFlLEVBQUUsTUFBTSxFQUFDLEdBQUcsV0FBVyxDQUFDLHNCQUFzQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNqRixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7UUFDbkQsTUFBTSxRQUFRLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUM7UUFFeEYsT0FBTyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBQyxlQUFlLEVBQUUsTUFBTSxFQUFDLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRUQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFZLEVBQUUsSUFBaUI7O1FBQzdDLE1BQU0sRUFBQyxNQUFNLEVBQUMsR0FBRyxJQUFJLENBQUM7UUFDdEIsTUFBTSxVQUFVLEdBQUcsV0FBVyxD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QztRQUVqSSxPQUFPLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDO0lBQ3BFLENBQUM7O0FBbkdNLDBCQUFjLEdBQUcsRUFBRSxDQUFDO0FBQ3BCLDBCQUFjLEdBQUcsT0FBTyxDQUFDO0FBQ3pCLG9DQUF3QixHQUFvQixNQUFNLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RhdGVUaW1lLCBEYXRlVGltZUZvcm1hdE9wdGlvbnMsIExvY2FsZU9wdGlvbnMsIE51bWJlcmluZ1N5c3RlbX0gZnJvbSAnbHV4b24nO1xuXG5pbXBvcnQge1RpbWVGb3JtYXR9IGZyb20gJy4uL21vZGVscy90aW1lLWZvcm1hdC5lbnVtJztcbmltcG9ydCB7VGltZVBlcmlvZH0gZnJvbSAnLi4vbW9kZWxzL3RpbWUtcGVyaW9kLmVudW0nO1xuaW1wb3J0IHtpc0JldHdlZW4sIGlzU2FtZU9yQWZ0ZXIsIGlzU2FtZU9yQmVmb3JlfSBmcm9tICcuLi91dGlscy90aW1lcGlja2VyLnV0aWxzJztcbmltcG9ydCB7VGltZU9wdGlvbnN9IGZyb20gJy4uL21vZGVscy90aW1lLW9wdGlvbnMuaW50ZXJmYWNlJztcblxuLy8gQGR5bmFtaWNcbmV4cG9ydCBjbGFzcyBUaW1lQWRhcHRlciB7XG4gICAgc3RhdGljIERFRkFVTFRfRk9STUFUID0gMTI7XG4gICAgc3RhdGljIERFRkFVTFRfTE9DQUxFID0gJ2VuLVVTJztcbiAgICBzdGF0aWMgREVGQVVMVF9OVU1CRVJJTkdfU1lTVEVNOiBOdW1iZXJpbmdTeXN0ZW0gPSAnbGF0bic7XG5cbiAgICBzdGF0aWMgcGFyc2VUaW1lKHRpbWU6IHN0cmluZywgb3B0czogVGltZU9wdGlvbnMpOiBEYXRlVGltZSB7XG4gICAgICAgIGNvbnN0IHtudW1iZXJpbmdTeXN0ZW0sIGxvY2FsZX0gPSBUaW1lQWRhcHRlci5nZXRMb2NhbGVPcHRpb25zQnlUaW1lKHRpbWUsIG9wdHMpO1xuICAgICAgICBjb25zdCBpc1BlcmlvZEV4aXN0ID0gdGltZS5zcGxpdCgnICcpLmxlbmd0aCA9PT0gMjtcbiAgICAgICAgY29uc3QgdGltZU1hc2sgPSBpc1BlcmlvZEV4aXN0ID8gVGltZUZvcm1hdC5UV0VMVkVfU0hPUlQgOiBUaW1lRm9ybWF0LlRXRU5UWV9GT1VSX1NIT1JUO1xuXG4gICAgICAgIHJldHVybiBEYXRlVGltZS5mcm9tRm9ybWF0KHRpbWUsIHRpbWVNYXNrLCB7bnVtYmVyaW5nU3lzdGVtLCBsb2NhbGV9KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZm9ybWF0VGltZSh0aW1lOiBzdHJpbmcsIG9wdHM6IFRpbWVPcHRpb25zKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3Qge2Zvcm1hdH0gPSBvcHRzO1xuICAgICAgICBjb25zdCBwYXJzZWRUaW1lID0gVGltZUFkYXB0ZXIucGFyc2VUaW1lKHRpbWUsIG9wdHMpLnNldExvY2FsZShUaW1lQWRhcHRlci5ERUZBVUxUX0xPQ0FMRSk7XG5cbiAgICAgICAgaWYgKGZvcm1hdCAhPT0gMjQpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXJzZWRUaW1lLnRvTG9jYWxlU3RyaW5nKHtcbiAgICAgICAgICAgICAgICAuLi5EYXRlVGltZS5USU1FX1NJTVBMRSxcbiAgICAgICAgICAgICAgICBob3VyMTI6IGZvcm1hdCAhPT0gMjQsXG4gICAgICAgICAgICAgICAgbnVtYmVyaW5nU3lzdGVtOiBUaW1lQWRhcHRlci5ERUZBVUxUX05VTUJFUklOR19TWVNURU1cbiAgICAgICAgICAgIH0pPy5yZXBsYWNlKC9cXHUyMDBFL2csICcnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcGFyc2VkVGltZS50b0lTT1RpbWUoe1xuICAgICAgICAgICAgaW5jbHVkZU9mZnNldDogZmFsc2UsXG4gICAgICAgICAgICBzdXBwcmVzc01pbGxpc2Vjb25kczogdHJ1ZSxcbiAgICAgICAgICAgIHN1cHByZXNzU2Vjb25kczogdHJ1ZVxuICAgICAgICB9KT8ucmVwbGFjZSgvXFx1MjAwRS9nLCAnJyk7XG4gICAgfVxuXG4gICAgc3RhdGljIHRvTG9jYWxlVGltZVN0cmluZyh0aW1lOiBzdHJpbmcsIG9wdHM6IFRpbWVPcHRpb25zID0ge30pOiBzdHJpbmcge1xuICAgICAgICBjb25zdCB7Zm9ybWF0ID0gVGltZUFkYXB0ZXIuREVGQVVMVF9GT1JNQVQsIGxvY2FsZSA9IFRpbWVBZGFwdGVyLkRFRkFVTFRfTE9DQUxFfSA9IG9wdHM7XG4gICAgICAgIGNvbnN0IHRpbWVGb3JtYXQ6IERhdGVUaW1lRm9ybWF0T3B0aW9ucyA9IHsuLi5EYXRlVGltZS5USU1FX1NJTVBMRSwgaG91cjEyOiBmb3JtYXQgIT09IDI0fTtcbiAgICAgICAgY29uc3QgdGltZU1hc2sgPSAoZm9ybWF0ID09PSAyNCkgPyBUaW1lRm9ybWF0LlRXRU5UWV9GT1VSX1NIT1JUIDogVGltZUZvcm1hdC5UV0VMVkVfU0hPUlQ7XG5cbiAgICAgICAgcmV0dXJuIERhdGVUaW1lLmZyb21Gb3JtYXQodGltZSwgdGltZU1hc2spLnNldExvY2FsZShsb2NhbGUpLnRvTG9jYWxlU3RyaW5nKHRpbWVGb3JtYXQpO1xuICAgIH1cblxuICAgIHN0YXRpYyBpc1RpbWVBdmFpbGFibGUoXG4gICAgICAgIHRpbWU6IHN0cmluZyxcbiAgICAgICAgbWluPzogRGF0ZVRpbWUsXG4gICAgICAgIG1heD86IERhdGVUaW1lLFxuICAgICAgICBncmFudWxhcml0eT86ICdob3VycycgfCAnbWludXRlcycsXG4gICAgICAgIG1pbnV0ZXNHYXA/OiBudW1iZXIgfCBudWxsLFxuICAgICAgICBmb3JtYXQ/OiBudW1iZXJcbiAgICApOiBib29sZWFuIHtcbiAgICAgICAgaWYgKCF0aW1lKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBjb252ZXJ0ZWRUaW1lID0gdGhpcy5wYXJzZVRpbWUodGltZSwge2Zvcm1hdH0pO1xuICAgICAgICBjb25zdCBtaW51dGVzID0gY29udmVydGVkVGltZS5taW51dGU7XG5cbiAgICAgICAgaWYgKG1pbnV0ZXNHYXAgJiYgbWludXRlcyA9PT0gbWludXRlcyAmJiBtaW51dGVzICUgbWludXRlc0dhcCAhPT0gMCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBZb3VyIG1pbnV0ZXMgLSAke21pbnV0ZXN9IGRvZXNuXFwndCBtYXRjaCB5b3VyIG1pbnV0ZXNHYXAgLSAke21pbnV0ZXNHYXB9YCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaXNBZnRlciA9IChtaW4gJiYgIW1heClcbiAgICAgICAgICAgICYmIGlzU2FtZU9yQWZ0ZXIoY29udmVydGVkVGltZSwgbWluLCBncmFudWxhcml0eSk7XG4gICAgICAgIGNvbnN0IGlzQmVmb3JlID0gKG1heCAmJiAhbWluKVxuICAgICAgICAgICAgJiYgaXNTYW1lT3JCZWZvcmUoY29udmVydGVkVGltZSwgbWF4LCBncmFudWxhcml0eSk7XG4gICAgICAgIGNvbnN0IGJldHdlZW4gPSAobWluICYmIG1heClcbiAgICAgICAgICAgICYmIGlzQmV0d2Vlbihjb252ZXJ0ZWRUaW1lLCBtaW4sIG1heCwgZ3JhbnVsYXJpdHkpO1xuICAgICAgICBjb25zdCBpc0F2YWlsYWJsZSA9ICFtaW4gJiYgIW1heDtcblxuICAgICAgICByZXR1cm4gaXNBZnRlciB8fCBpc0JlZm9yZSB8fCBiZXR3ZWVuIHx8IGlzQXZhaWxhYmxlO1xuICAgIH1cblxuICAgIC8qKipcbiAgICAgKiAgRm9ybWF0IGhvdXIgYWNjb3JkaW5nIHRvIHRpbWUgZm9ybWF0ICgxMiBvciAyNClcbiAgICAgKi9cbiAgICBzdGF0aWMgZm9ybWF0SG91cihjdXJyZW50SG91cjogbnVtYmVyLCBmb3JtYXQ6IG51bWJlciwgcGVyaW9kOiBUaW1lUGVyaW9kKTogbnVtYmVyIHtcbiAgICAgICAgaWYgKGZvcm1hdCA9PT0gMjQpIHtcbiAgICAgICAgICAgIHJldHVybiBjdXJyZW50SG91cjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBob3VyID0gcGVyaW9kID09PSBUaW1lUGVyaW9kLkFNID8gY3VycmVudEhvdXIgOiBjdXJyZW50SG91ciArIDEyO1xuXG4gICAgICAgIGlmIChwZXJpb2QgPT09IFRpbWVQZXJpb2QuQU0gJiYgaG91ciA9PT0gMTIpIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9IGVsc2UgaWYgKHBlcmlvZCA9PT0gVGltZVBlcmlvZC5QTSAmJiBob3VyID09PSAyNCkge1xuICAgICAgICAgICAgcmV0dXJuIDEyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBob3VyO1xuICAgIH1cblxuICAgIHN0YXRpYyBmcm9tRGF0ZVRpbWVUb1N0cmluZyh0aW1lOiBEYXRlVGltZSwgZm9ybWF0OiBudW1iZXIpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCB0aW1lRm9ybWF0ID0gZm9ybWF0ID09PSAyNCA/IFRpbWVGb3JtYXQuVFdFTlRZX0ZPVVIgOiBUaW1lRm9ybWF0LlRXRUxWRTtcblxuICAgICAgICByZXR1cm4gdGltZS5yZWNvbmZpZ3VyZSh7XG4gICAgICAgICAgICBudW1iZXJpbmdTeXN0ZW06IFRpbWVBZGFwdGVyLkRFRkFVTFRfTlVNQkVSSU5HX1NZU1RFTSxcbiAgICAgICAgICAgIGxvY2FsZTogVGltZUFkYXB0ZXIuREVGQVVMVF9MT0NBTEVcbiAgICAgICAgfSkudG9Gb3JtYXQodGltZUZvcm1hdCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ2V0TG9jYWxlT3B0aW9uc0J5VGltZSh0aW1lOiBzdHJpbmcsIG9wdHM6IFRpbWVPcHRpb25zKTogTG9jYWxlT3B0aW9ucyB7XG4gICAgICAgIGNvbnN0IHtudW1iZXJpbmdTeXN0ZW0sIGxvY2FsZX0gPSBEYXRlVGltZS5sb2NhbCgpLnNldExvY2FsZShvcHRzLmxvY2FsZSkucmVzb2x2ZWRMb2NhbGVPcHRzKCk7XG4gICAgICAgIGNvbnN0IGxvY2FsZUNvbmZpZzogTG9jYWxlT3B0aW9ucyA9IHtudW1iZXJpbmdTeXN0ZW06IG51bWJlcmluZ1N5c3RlbSBhcyBOdW1iZXJpbmdTeXN0ZW0sIGxvY2FsZX07XG4gICAgICAgIGNvbnN0IGRlZmF1bHRDb25maWc6IExvY2FsZU9wdGlvbnMgPSB7bnVtYmVyaW5nU3lzdGVtOiBUaW1lQWRhcHRlci5ERUZBVUxUX05VTUJFUklOR19TWVNURU0sIGxvY2FsZTogVGltZUFkYXB0ZXIuREVGQVVMVF9MT0NBTEV9O1xuXG4gICAgICAgIHJldHVybiBpc05hTihwYXJzZUludCh0aW1lLCAxMCkpID8gbG9jYWxlQ29uZmlnIDogZGVmYXVsdENvbmZpZztcbiAgICB9XG59XG4iXX0=